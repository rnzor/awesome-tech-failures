openapi: 3.0.3
info:
  title: Awesome Tech Failures API
  description: |
    API for querying tech failures, patterns, and similarity search.
    
    **Client-Side Similarity Search:**
    This API uses a hybrid embedding approach:
    1. Pre-embedded common terms (fast, no API key needed)
    2. Optional custom query embeddings via external API
    
    Frontend should load `embeddings.json` once and perform similarity calculations in-browser.
  version: 1.0.0
  contact:
    name: Repository
    url: https://github.com/rnzor/awesome-tech-failures
  license:
    name: CC0-1.0
    url: https://creativecommons.org/publicdomain/zero/1.0/

servers:
  - url: https://rnzor.github.io/awesome-tech-failures/api
    description: Production GitHub Pages (static JSON files)
  - url: http://localhost:3000/api
    description: Local development (Vite dev server)

tags:
  - name: Failures
    description: Tech failure entries
  - name: Patterns
    description: Failure patterns
  - name: Search
    description: Semantic similarity search
  - name: Metadata
    description: API metadata and tags

paths:
  /failures:
    get:
      tags:
        - Failures
      summary: List all failure entries
      description: |
        Retrieve a paginated list of tech failures with optional filtering.
        All filtering is performed client-side after loading the full dataset.
      parameters:
        - name: category
          in: query
          schema:
            type: string
            enum:
              - ai-slop
              - outage
              - security
              - startup
              - product
              - decision
            description: Filter by category (e.g., 'ai-slop')
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
          description: Filter by specific tags (e.g., ['no-rollback', 'blind-trust'])
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
            description: Max records to return (default: 20)
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
            description: Pagination offset
      responses:
        '200':
          description: Filtered list of failure entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    description: Total count before filtering
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Failure'

  /failures/{id}:
    get:
      tags:
        - Failures
      summary: Get specific failure entry
      description: |
        Retrieve full post-mortem details and impact analysis for a specific ID.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Unique failure ID (e.g., 'crowdstrike-bsod')
      responses:
        '200':
          description: Full failure entry with details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Failure'
        '404':
          description: Failure entry not found

  /search/similarity:
    post:
      tags:
        - Search
      summary: Find similar failures
      description: |
        **Client-Side Implementation:**
        
        This endpoint performs semantic search using pre-computed embeddings.
        
        **Hybrid Mode:**
        1. Check if query is in `hybrid_lookup.json` → Use pre-embedded vector
        2. If not found, optionally call embedding API for custom query
        3. Calculate cosine similarity in-browser against all embeddings
        4. Return top-K matches with optional filtering
        
        Frontend should:
        1. Load `embeddings.json` on app mount (~256KB)
        2. Load `hybrid_lookup.json` for pre-embedded terms
        3. For search, check hybrid lookup first, then optionally call embedding API
        4. Calculate cosine similarity: `dot(a, b) / (norm(a) * norm(b))`
        5. Apply filters and return top-K results
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
              properties:
                query:
                  type: string
                  description: Natural language query
                  example: "What can go wrong with AI agents and database access?"
                top_k:
                  type: integer
                  default: 5
                  description: Number of results to return (max 20)
                  minimum: 1
                  maximum: 20
                filters:
                  type: object
                  description: Optional filters to apply to results
                  properties:
                    category:
                      type: string
                      enum:
                        - ai-slop
                        - outage
                        - security
                        - startup
                        - product
                        - decision
                    severity:
                      type: string
                      enum:
                        - critical
                        - high
                        - medium
                        - low
                    tags:
                      type: array
                      items:
                        type: string
                use_hybrid_only:
                  type: boolean
                  default: true
                  description: Use only pre-embedded terms (no API call)
                embedding_api_key:
                  type: string
                  description: Optional API key for custom query embedding
      responses:
        '200':
          description: Similar failures with similarity scores
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      allOf:
                        - $ref: '#/components/schemas/Failure'
                        - type: object
                          properties:
                            similarity_score:
                              type: number
                              format: float
                              minimum: 0
                              maximum: 1
                              description: Cosine similarity score (0-1)
                  query_matched_hybrid:
                    type: boolean
                    description: True if query was found in pre-embedded terms
                  total_candidates:
                    type: integer
                    description: Total entries before filtering

  /patterns:
    get:
      tags:
        - Patterns
      summary: List all failure patterns
      responses:
        '200':
          description: Array of failure patterns
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Pattern'

  /patterns/{id}:
    get:
      tags:
        - Patterns
      summary: Get specific failure pattern
      description: Get pattern with related entries
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Pattern ID (e.g., 'automation-without-reversal')
      responses:
        '200':
          description: Pattern with related entries
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Pattern'
                  - type: object
                    properties:
                      related_entries:
                        type: array
                        items:
                          $ref: '#/components/schemas/Failure'

  /tags:
    get:
      tags:
        - Metadata
      summary: Get tag definitions
      responses:
        '200':
          description: Tag definitions and taxonomy
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                  tag_types:
                    type: object
                  free_tags:
                    type: array

  /hybrid_lookup:
    get:
      tags:
        - Metadata
      summary: Get pre-embedded terms
      description: |
        Retrieve pre-embedded vectors for common terms.
        Used by client-side similarity search to avoid API calls.
      responses:
        '200':
          description: Pre-embedded term lookup table
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                  generated_at:
                    type: string
                  dimensions:
                    type: integer
                  terms:
                    type: object
                    description: Maps term → {vector, usage_count}

components:
  schemas:
    Failure:
      type: object
      required:
        - id
        - title
        - year
        - category
        - cause
        - severity
        - summary
      properties:
        id:
          type: string
          example: aws-s3-us-east-1-2017
        title:
          type: string
          example: AWS S3 us-east-1 Outage
        year:
          type: integer
          example: 2017
        evidence_type:
          type: string
          enum:
            - direct_incident
            - repeated_pattern
        category:
          type: string
          enum:
            - ai-slop
            - outage
            - security
            - startup
            - product
            - decision
        cause:
          type: string
          enum:
            - human-error
            - automation
            - architecture
            - incentives
            - ai
            - timing
            - ecosystem
            - ux-mismatch
            - platform-risk
            - no-pmf
            - deployment-validation
            - latent-bug
        stage:
          type: string
          enum:
            - early
            - growth
            - scale
            - decline
        impact:
          type: array
          items:
            type: string
        severity:
          type: object
          properties:
            level:
              type: string
              enum:
                - critical
                - high
                - medium
                - low
            score:
              type: integer
              minimum: 1
              maximum: 10
            financial:
              type: string
        summary:
          type: string
        root_cause:
          type: string
        lessons:
          type: array
          items:
            type: string
        patterns:
          type: array
          items:
            type: string
        tags:
          type: array
          items:
            type: string
        sources:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              url:
                type: string
                format: uri
              kind:
                type: string
                enum:
                  - primary
                  - secondary

    Pattern:
      type: object
      required:
        - id
        - title
        - description
      properties:
        id:
          type: string
          example: automation-without-reversal
        title:
          type: string
          example: Automation Without Reversal
        description:
          type: string
        common_tags:
          type: array
          items:
            type: string
        related_categories:
          type: array
          items:
            type: string
        examples:
          type: array
          items:
            type: string
        playbooks:
          type: array
          items:
            type: string
